{% extends "base.html" %}

{% block title %}{{ request.company_name }} - Admin - TezzaWorks{% endblock %}

{% block nav_links %}
<div class="flex items-center space-x-4">
    <a href="{{ url_for('admin.dashboard') }}" class="text-sm hover:text-gray-200">
        <i class="fas fa-arrow-left mr-1"></i>Dashboard
    </a>
    <span class="text-sm"><i class="fas fa-user mr-2"></i>{{ session.admin_username }}</span>
    <a href="{{ url_for('admin.logout') }}" class="text-sm hover:text-gray-200">
        <i class="fas fa-sign-out-alt mr-1"></i>Logout
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header with Status -->
    <div class="mb-8">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-4xl font-bold text-gray-800 mb-2">{{ request.company_name }}</h1>
                <p class="text-gray-600">Design Request Details</p>
            </div>
            <div>
                {% if request.status == 'pending' %}
                <span class="px-6 py-3 bg-yellow-100 text-yellow-700 rounded-full font-semibold">
                    <i class="fas fa-clock mr-2"></i>Pending
                </span>
                {% elif request.status == 'in_progress' %}
                <span class="px-6 py-3 bg-blue-100 text-blue-700 rounded-full font-semibold">
                    <i class="fas fa-paint-brush mr-2"></i>In Progress
                </span>
                {% else %}
                <span class="px-6 py-3 bg-green-100 text-green-700 rounded-full font-semibold">
                    <i class="fas fa-check-circle mr-2"></i>Completed
                </span>
                {% endif %}
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-3">
            <a href="{{ url_for('client.gallery', token=request.gallery_token) }}"
               target="_blank"
               class="bg-purple-600 text-white py-2 px-6 rounded-lg hover:bg-purple-700 transition">
                <i class="fas fa-external-link-alt mr-2"></i>View Client Gallery
            </a>
            {% if designs %}
            <a href="{{ url_for('admin.generate_pdf', request_id=request.id) }}"
               class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition">
                <i class="fas fa-file-pdf mr-2"></i>Generate PDF
            </a>
            {% endif %}
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Content Area -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Client Information -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-user-circle mr-3 text-purple-600"></i>
                    Client Information
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Contact Name</p>
                        <p class="text-gray-800">{{ request.contact_name }}</p>
                    </div>
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Email</p>
                        <p class="text-gray-800">{{ request.contact_email }}</p>
                    </div>
                    {% if request.contact_phone %}
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Phone</p>
                        <p class="text-gray-800">{{ request.contact_phone }}</p>
                    </div>
                    {% endif %}
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-1">Submitted</p>
                        <p class="text-gray-800">{{ request.created_at.strftime('%B %d, %Y at %I:%M %p') }}</p>
                    </div>
                </div>
            </div>

            <!-- Brand Information -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-palette mr-3 text-purple-600"></i>
                    Brand Profile
                </h2>
                <div class="space-y-4">
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-2">Brand Keywords</p>
                        <p class="text-gray-800">{{ request.brand_keywords }}</p>
                    </div>
                    {% if request.brand_colors %}
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-2">Brand Colors</p>
                        <p class="text-gray-800">{{ request.brand_colors }}</p>
                    </div>
                    {% endif %}
                    {% if request.target_audience %}
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-2">Target Audience</p>
                        <p class="text-gray-800">{{ request.target_audience }}</p>
                    </div>
                    {% endif %}
                    {% if request.additional_notes %}
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-2">Additional Notes</p>
                        <p class="text-gray-800">{{ request.additional_notes }}</p>
                    </div>
                    {% endif %}
                    {% if request.logo_filename %}
                    <div>
                        <p class="text-sm font-semibold text-gray-600 mb-2">Client Logo</p>
                        <img src="{{ url_for('static', filename='uploads/' + request.logo_filename) }}"
                             alt="Client Logo"
                             class="max-w-xs rounded border">
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Design Upload Section -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-cloud-upload-alt mr-3 text-purple-600"></i>
                    Upload Design Options
                </h2>

                <form action="{{ url_for('admin.upload_design', request_id=request.id) }}"
                      method="POST"
                      enctype="multipart/form-data"
                      class="space-y-4">

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Design Title
                        </label>
                        <input type="text"
                               name="design_title"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                               placeholder="e.g., Modern Corporate Look">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Design Description
                        </label>
                        <textarea name="design_description"
                                  rows="3"
                                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent"
                                  placeholder="Describe this design option..."></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                            Design Image
                        </label>
                        <input type="file"
                               name="design_file"
                               required
                               accept=".png,.jpg,.jpeg,.pdf"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                        <p class="text-sm text-gray-500 mt-1">Accepted formats: PNG, JPG, JPEG, PDF</p>
                    </div>

                    <button type="submit"
                            class="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-upload mr-2"></i>Upload Design
                    </button>
                </form>
            </div>

            <!-- Uploaded Designs -->
            {% if designs %}
            <div class="bg-white rounded-lg card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-images mr-3 text-purple-600"></i>
                    Uploaded Designs ({{ designs|length }})
                </h2>

                <div class="space-y-6">
                    {% for design in designs %}
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex gap-4">
                            <img src="{{ url_for('static', filename='uploads/' + design.filename) }}"
                                 alt="{{ design.title or 'Design' }}"
                                 class="w-32 h-32 object-cover rounded">

                            <div class="flex-1">
                                <form action="{{ url_for('admin.update_design', request_id=request.id, design_id=design.id) }}"
                                      method="POST"
                                      class="space-y-2">
                                    <input type="text"
                                           name="design_title"
                                           value="{{ design.title or '' }}"
                                           class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                           placeholder="Design title">

                                    <textarea name="design_description"
                                              rows="2"
                                              class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                              placeholder="Description">{{ design.description or '' }}</textarea>

                                    <div class="flex space-x-2">
                                        <button type="submit"
                                                class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600 transition">
                                            <i class="fas fa-save mr-1"></i>Update
                                        </button>

                                        <button type="button"
                                                onclick="deleteDesign({{ request.id }}, {{ design.id }})"
                                                class="bg-red-500 text-white px-4 py-2 rounded text-sm hover:bg-red-600 transition">
                                            <i class="fas fa-trash mr-1"></i>Delete
                                        </button>
                                    </div>
                                </form>

                                {% if design.is_selected %}
                                <p class="text-green-600 text-sm font-semibold mt-2">
                                    <i class="fas fa-heart mr-1"></i>Selected by client
                                </p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Client Feedback -->
            {% if feedback %}
            <div class="bg-white rounded-lg card-shadow p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-comment-dots mr-3 text-purple-600"></i>
                    Client Feedback
                </h2>

                {% if feedback.rating %}
                <div class="mb-4">
                    <p class="text-sm font-semibold text-gray-600 mb-2">Rating</p>
                    <div class="flex space-x-1">
                        {% for i in range(1, 6) %}
                            {% if i <= feedback.rating %}
                                <i class="fas fa-star text-yellow-400 text-xl"></i>
                            {% else %}
                                <i class="far fa-star text-gray-300 text-xl"></i>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                {% if feedback.overall_feedback %}
                <div>
                    <p class="text-sm font-semibold text-gray-600 mb-2">Comments</p>
                    <p class="text-gray-800 bg-gray-50 p-4 rounded">{{ feedback.overall_feedback }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Status Update -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Update Status</h3>
                <form action="{{ url_for('admin.update_status', request_id=request.id) }}" method="POST">
                    <select name="status"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-purple-600 focus:border-transparent">
                        <option value="pending" {% if request.status == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="in_progress" {% if request.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if request.status == 'completed' %}selected{% endif %}>Completed</option>
                    </select>
                    <button type="submit"
                            class="w-full bg-purple-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-purple-700 transition">
                        <i class="fas fa-save mr-2"></i>Update Status
                    </button>
                </form>
            </div>

            <!-- Quick Links -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Quick Links</h3>
                <div class="space-y-2">
                    <a href="{{ url_for('client.gallery', token=request.gallery_token) }}"
                       target="_blank"
                       class="block w-full bg-gray-100 text-gray-700 text-center py-2 px-4 rounded-lg hover:bg-gray-200 transition">
                        <i class="fas fa-external-link-alt mr-2"></i>Client Gallery
                    </a>
                    <a href="mailto:{{ request.contact_email }}"
                       class="block w-full bg-gray-100 text-gray-700 text-center py-2 px-4 rounded-lg hover:bg-gray-200 transition">
                        <i class="fas fa-envelope mr-2"></i>Email Client
                    </a>
                </div>
            </div>

            <!-- Gallery Token -->
            <div class="bg-white rounded-lg card-shadow p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Gallery Link</h3>
                <div class="bg-gray-50 p-3 rounded text-xs break-all">
                    <code>{{ url_for('client.gallery', token=request.gallery_token, _external=True) }}</code>
                </div>
                <button onclick="copyGalleryLink()"
                        class="w-full mt-3 bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition text-sm">
                    <i class="fas fa-copy mr-2"></i>Copy Link
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function deleteDesign(requestId, designId) {
    if (confirm('Are you sure you want to delete this design? This action cannot be undone.')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/request/${requestId}/delete_design/${designId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

function copyGalleryLink() {
    const link = '{{ url_for('client.gallery', token=request.gallery_token, _external=True) }}';
    navigator.clipboard.writeText(link).then(function() {
        alert('Gallery link copied to clipboard!');
    }, function(err) {
        console.error('Could not copy text: ', err);
    });
}
</script>
{% endblock %}
